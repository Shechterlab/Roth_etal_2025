---
title: "Dynamic Gviz Visualization Workflow"
author: "David Shechter"
date: Sys.Date()
output: 
  html_document:
    toc: true
    toc_float: true
params:
  input_csv: "C:/Users/david/OneDrive/Bioinformatics/PRMTi/HLB_GViz/HLB_PRMT5_HINFP_etc.csv" # Path to your CSV file
  output_dir: "C:/Users/david/OneDrive/Bioinformatics/PRMTi/HLB_GViz"   # Directory to save results
---

```{r setup, include=TRUE, warning=FALSE}
# Load required libraries
library(Gviz)
library(tidyverse)
library(fs) # For file system operations

# Custom operator for default values
`%||%` <- function(a, b) if (!is.null(a)) a else b

# Create output directory if it doesn't exist
if (!dir_exists(params$output_dir)) dir_create(params$output_dir)

# Function to validate required columns in the input CSV
validate_columns <- function(data, required_columns) {
  missing_columns <- setdiff(required_columns, colnames(data))
  if (length(missing_columns) > 0) {
    stop(paste("The following required columns are missing in the CSV:",
               paste(missing_columns, collapse = ", ")))
  }
}

# Load the CSV file specified in YAML parameters
track_data <- read_csv(params$input_csv)

# Validate required columns in the CSV
required_columns <- c("file_path", "track_name", "type", "genome", "chromosome", "start", "end")
validate_columns(track_data, required_columns)

# Preview the data
print(head(track_data))


```

```{r Create Dynamic Gviz Tracks, include=FALSE}

# Function to create Gviz tracks based on a row of input data
create_track <- function(row) {
  file_path <- row$file_path
  track_name <- row$track_name
  type <- row$type
  genome <- row$genome
  chromosome <- row$chromosome
  other_annotations <- row$other_annotations %||% NULL

  print(paste("Processing track:", row$track_name, "of type:", row$type))
   
  # Parse other_annotations into a list of arguments
  extra_args <- if (!is.null(other_annotations)) {
    eval(parse(text = paste0("list(", other_annotations, ")")))
  } else list()

  # Create the appropriate track
  track <- tryCatch({
    switch(type,
      "DataTrack" = do.call(DataTrack, c(
        list(range = file_path, name = track_name, genome = genome, chromosome = chromosome),
        extra_args
      )),
      "GenomeAxisTrack" = do.call(GenomeAxisTrack, extra_args),
      "IdeogramTrack" = do.call(IdeogramTrack, c(
        list(genome = genome, chromosome = chromosome),
        extra_args
      )),
      "BiomartGeneRegionTrack" = do.call(BiomartGeneRegionTrack, c(
        list(genome = genome, chromosome = chromosome, start = row$start, end = row$end, name = track_name, biomart = useMart("ensembl")),
        extra_args
      )),
      stop(paste("Unsupported track type:", type))
    )
  }, error = function(e) {
    warning(paste("Error creating track for type:", type, ":", e$message))
    NULL
  })

  if (is.null(track)) stop(paste("Track creation failed for type:", type))
  return(track)
}

# Create tracks for all rows in the CSV
tracks <- lapply(1:nrow(track_data), function(i) {
  row <- track_data[i, ]
  tryCatch(
    create_track(row),
    error = function(e) {
      warning(paste("Failed to create track for row", i, ":", e$message))
      NULL
    }
  )
})

# Filter out NULL tracks in case of errors
tracks <- Filter(Negate(is.null), tracks)

# Debugging: Print created tracks
print(paste("Number of tracks created:", length(tracks)))



```


```{r Set Genomic Region and Combine Tracks, incude=TRUE}
# Extract genomic region from the first row
region <- track_data[1, ]
chromosome <- region$chromosome
start <- region$start
end <- region$end

# Add genome axis and ideogram tracks
genome_track <- GenomeAxisTrack()
ideo_track <- IdeogramTrack(genome = region$genome, chromosome = chromosome)

# Combine all tracks, including genome and ideogram tracks
all_tracks <- c(ideo_track, genome_track, tracks)

```

```{r Generate and Save the Plot, include=TRUE}

# Save the plot object
plot <- plotTracks(
  all_tracks,
  from = start,
  to = end,
  chromosome = chromosome
)

# Display the plot inline in the Markdown document
plot

# Save the plot as a PDF
output_file_pdf <- file.path(params$output_dir, "genome_plot.pdf")
pdf(output_file_pdf, width = 12, height = 8) # Open PDF device
plotTracks(
  all_tracks,
  from = start,
  to = end,
  chromosome = chromosome
)
dev.off() # Close PDF device

# Confirm output location
cat("PDF plot saved to:", output_file_pdf, "\n")


```